<?php

namespace MissionBundle\Repository;

use Doctrine\ORM\EntityRepository;
use MissionBundle\Entity\Mission;

/**
 * WorkExperienceRepository
 *
 * This class was generated by the Doctrine ORM. Add your own custom
 * repository methods below.
 */
class WorkExperienceRepository extends EntityRepository
{
    /**
     * @param \MissionBundle\Entity\Mission $mission
     * @return \Doctrine\ORM\QueryBuilder
     */
    public function queryWorkExp(Mission $mission)
    {
        $qb = $this->_em->createQueryBuilder();

        $qb->select('u')
            ->from('MissionBundle:WorkExperience', 'u')
            ->join('u.missionKinds', 'm')
            ->join('u.professionalExpertises', 'p')
            ->join('u.businessPractices', 'b')
            ->join('u.missionTitles', 't')

            ->where('u.name != :create')
            ->andWhere('b  = :businessPra OR p = :proExp OR m.id IN (:missionKinds) OR t in (:title)')

            ->setParameter('proExp', $mission->getProfessionalExpertise())
            ->setParameter('missionKinds', $mission->getMissionKinds()->toArray())
            ->setParameter('businessPra', $mission->getBusinessPractice())
            ->setParameter('create', 'workexperience.create')
            ->setParameter('title', $mission->getTitle())


            ->orderBy('u.id', 'ASC')
        ;

        return $qb;
    }

    public function findWorkExp($mission)
    {
        return $this->queryWorkExp($mission)->getQuery()->getResult();
    }
}