<?php

namespace MissionBundle\Repository;

use Doctrine\ORM\EntityRepository;

/**
 * MissionRepository
 * This class was generated by the Doctrine ORM. Add your own custom
 * repository methods below.
 */
class MissionRepository extends EntityRepository
{
    public function getExpertMissionsAvailables()
    {
        $qb = $this->_em->createQueryBuilder();
        $qb->select('m')
        ->from('MissionBundle:Mission', 'm')
        ->where('m.status >= 1')
        ->orderBy('m.applicationEnding', 'DESC');
        return $qb->getQuery()->getResult();
    }

    /**
     * A magic query that return a array of potential mission for a user
     * Need to refacto that shit, that burn my eyes
     *
     * @param $user
     *
     * @return array
     */
    public function getMissionByUser($user)
    {
        // select all mission at step one
        // left join necessary table
        $base = "SELECT   m
                FROM      MissionBundle:Mission m 
                LEFT JOIN m.languages l 
                LEFT JOIN m.businessPractice b 
                LEFT JOIN m.professionalExpertise p 
                LEFT JOIN m.missionKind k 
                LEFT JOIN m.userMission um
                WHERE     um.user = :user
                AND       um.status >= 0
                AND       m.status = 1";

        // add each user language in the query
        $i = 0;
        foreach ($user->getLanguages() as $oneLanguage) {
            if ($i)
                $base = $base . '
                OR        l = :userLanguage' . $i;
            else
                $base = $base . '
                AND       (l = :userLanguage' . $i;
            $i++;
        }
        // add each user practice in the query
        $i = 0;
        foreach ($user->getBusinessPractice() as $onePractice) {
            if ($i)
                $base = $base . '
                OR        b = :userPractice' . $i;
            else
                $base = $base . ')
                AND       (b = :userPractice' . $i;
            $i++;
        }
        // add each user expertise in the query
        $i = 0;
        foreach ($user->getProfessionalExpertise() as $oneExp) {
            if ($i)
                $base = $base . ' 
                OR        p = :userExp' . $i;
            else
                $base = $base . ') 
                AND       (p = :userExp' . $i;
            $i++;
        }
        // add each user mission kind in the query
        $i = 0;
        foreach ($user->getMissionKind() as $oneKind) {
            if ($i)
                $base = $base . '
                OR        k = :userKind' . $i;
            else
                $base = $base . ')
                AND       (k = :userKind' . $i;
            $i++;
        }

        // add ordering method to the query
        $base  = $base . ')
         ORDER BY         m.applicationEnding DESC';
        $query = $this->_em->createQuery($base);

        // add parameters to the query
        $query->setParameter('user', $user);
        $i = 0;
        foreach ($user->getLanguages() as $oneLanguage) {
            $query->setParameter('userLanguage' . $i, $oneLanguage);
            $i++;
        }
        $i = 0;
        foreach ($user->getBusinessPractice() as $onePractice) {
            $query->setParameter('userPractice' . $i, $onePractice);
            $i++;
        }
        $i = 0;
        foreach ($user->getProfessionalExpertise() as $oneExp) {
            $query->setParameter('userExp' . $i, $oneExp);
            $i++;
        }
        $i = 0;
        foreach ($user->getMissionKind() as $oneKind) {
            $query->setParameter('userKind' . $i, $oneKind);
            $i++;
        }

        // return the result + the query
        return $query->getResult();
    }

    /**
     * A magic query that return a array of potential user for a mission
     * Need to refacto that shit, that burn my eyes
     *
     * @param      $mission
     * @param bool $ignored
     * @param bool $dql
     *
     * @return array
     */
    public function getUsersByMission($mission, $ignored = true, $dql = false)
    {
        // select all advisor fully register
        // left join necessary table
        $base = "SELECT   u 
                FROM      UserBundle:User u
                LEFT JOIN u.languages l 
                LEFT JOIN u.professionalExpertise p
                LEFT JOIN u.missionKind k
                LEFT JOIN u.businessPractice b
                LEFT JOIN u.userMission um
                WHERE     u.status = 5
                AND       u.roles = :userRoles";

        // add language filter
        $i = 0;
        foreach ($mission->getLanguages() as $oneLanguage) {
            if ($i)
                $base = $base . '
                OR        l = :missionLanguage' . $i;
            else
                $base = $base . '
                AND       (l = :missionLanguage' . $i;
            $i++;
        }
        // add professionalExpertise filter
        $base = $base . ')
                AND       p = :professionalExpertise';
        // add missionKind filter
        $base = $base . '
                AND       k = :missionKind';
        // add businessPractice filter
        $base = $base . '
                AND       b = :businessPractice';
        // if ingored, add userMission filter (user that haven't refused the mission)
        if ($ignored)
            $base = $base . '
                AND       um.mission = :mission
                AND       um.status = 0';
        // order user by id
        $base = $base . '
                ORDER BY  u.id ASC';

        // create DQL query
        $query = $this->_em->createQuery($base);

        // add parameters to the query
        $query->setParameter('userRoles', "a:1:{i:0;s:12:\"ROLE_ADVISOR\";}");
        $i = 0;
        foreach ($mission->getLanguages() as $oneLanguage) {
            $query->setParameter('missionLanguage' . $i, $oneLanguage);
            $i++;
        }
        $query->setParameter('professionalExpertise', $mission->getProfessionalExpertise());
        $query->setParameter('missionKind', $mission->getMissionKind());
        $query->setParameter('businessPractice', $mission->getBusinessPractice());
        if ($ignored)
            $query->setParameter('mission', $mission->getId());

        // return the result
        if ($dql)
            return [$query->getResult(), $query->getDQL()];
        return $query->getResult();
    }

}
